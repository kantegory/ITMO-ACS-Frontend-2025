<!DOCTYPE html>
<html lang="ru">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>–ö—É–ª–∏–Ω–∞—Ä–Ω–æ–µ —Å–æ–æ–±—â–µ—Å—Ç–≤–æ</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="index.css" />
  </head>
  <body class="bg-light">
    <nav class="navbar navbar-expand-lg navbar-white bg-white shadow-sm">
      <div class="container">
        <a class="navbar-brand text-danger fw-bold" href="index.html"
          >üç≥ –ö—É–ª–∏–Ω–∞—Ä–Ω–æ–µ —Å–æ–æ–±—â–µ—Å—Ç–≤–æ</a
        >
        <button
          class="navbar-toggler"
          type="button"
          data-bs-toggle="collapse"
          data-bs-target="#navbarNav"
        >
          <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarNav">
          <ul class="navbar-nav me-auto">
            <li class="nav-item">
              <a class="nav-link" href="index.html">–ì–ª–∞–≤–Ω–∞—è</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="search.html">–ü–æ–∏—Å–∫ —Ä–µ—Ü–µ–ø—Ç–æ–≤</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="profile.html">–õ–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç</a>
            </li>
          </ul>
          <ul class="navbar-nav">
            <li class="nav-item">
              <a class="nav-link" href="login.html">–í—Ö–æ–¥</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="register.html">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</a>
            </li>
          </ul>
        </div>
      </div>
    </nav>

    <main class="container my-5">
      <div class="row">
        <div class="col-lg-8">
          <div class="card shadow-sm border-0 mb-4">
            <h1
              class="display-6 fw-bold text-danger mb-2 p-3 pb-0"
              id="recipeTitle"
            >
              –°–ø–∞–≥–µ—Ç—Ç–∏ –ö–∞—Ä–±–æ–Ω–∞—Ä–∞
            </h1>
            <div class="card-body">
              <img
                src=""
                class="img-fluid rounded-start"
                style="height: 400px; width: 100%; object-fit: cover"
                id="mainPicture"
              />
            </div>
          </div>

          <div class="card shadow-sm border-0 mb-4">
            <div class="card-body">
              <h4 class="text-danger mb-4">–ò–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç—ã</h4>
              <div class="row">
                <div class="col-md-6">
                  <ul id="ingredientsList"></ul>
                </div>
              </div>
            </div>
          </div>

          <div class="card shadow-sm border-0 mb-4">
            <div class="card-body">
              <h4 class="text-danger mb-4">–ü–æ—à–∞–≥–æ–≤–æ–µ –ø—Ä–∏–≥–æ—Ç–æ–≤–ª–µ–Ω–∏–µ</h4>
              <div
                class="card-text"
                id="recipeSteps"
                style="white-space: pre-wrap"
              ></div>
            </div>
          </div>

          <div class="card shadow-sm border-0">
            <div class="card-body">
              <div
                class="d-flex justify-content-between align-items-center mb-4"
              >
                <h4 class="text-danger mb-0">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏</h4>
              </div>

              <div class="mb-4">
                <div class="d-flex gap-3">
                  <div class="flex-grow-1">
                    <textarea
                      class="form-control"
                      id="commentText"
                      placeholder="–ù–∞–ø–∏—à–∏—Ç–µ –≤–∞—à –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π..."
                      rows="3"
                    ></textarea>
                    <div
                      class="d-flex justify-content-between align-items-center mt-2"
                    >
                      <small class="text-muted">–ú–∏–Ω–∏–º—É–º 10 —Å–∏–º–≤–æ–ª–æ–≤</small>
                      <button class="btn btn-danger" id="submitCommentBtn">
                        –û—Ç–ø—Ä–∞–≤–∏—Ç—å
                      </button>
                    </div>
                  </div>
                </div>
              </div>

              <div id="commentsList"></div>
            </div>
          </div>
        </div>

        <div class="col-lg-4">
          <div class="card shadow-sm border-0 mb-4">
            <div class="card-body pb-1">
              <h5 class="text-danger mb-3">–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Ä–µ—Ü–µ–ø—Ç–µ</h5>
              <div class="mb-3">
                <div
                  class="d-flex justify-content-between align-items-center py-2 border-bottom"
                >
                  <span class="text-muted">–û–±—â–µ–µ –≤—Ä–µ–º—è</span>
                  <span class="fw-semibold" id="totalTime">25 –º–∏–Ω—É—Ç</span>
                </div>
                <div
                  class="d-flex justify-content-between align-items-center py-2 border-bottom"
                >
                  <span class="text-muted">–ê–∫—Ç–∏–≤–Ω–æ–µ –≤—Ä–µ–º—è</span>
                  <span class="fw-semibold" id="activeTime">15 –º–∏–Ω—É—Ç</span>
                </div>
                <div
                  class="d-flex justify-content-between align-items-center py-2 border-bottom"
                >
                  <span class="text-muted">–¢–∏–ø –±–ª—é–¥–∞</span>
                  <span class="fw-semibold" id="dishType">–°—É–ø</span>
                </div>
                <div
                  class="d-flex justify-content-between align-items-center py-2"
                >
                  <span class="text-muted">–°–ª–æ–∂–Ω–æ—Å—Ç—å</span>
                  <span class="fw-semibold" id="difficulty">–°—Ä–µ–¥–Ω—è—è</span>
                </div>
              </div>
            </div>
          </div>

        </div>
      </div>
    </main>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    <script src="index.js"></script>
    <script>
      const recipeTitle = document.querySelector("#recipeTitle");
      const mainPicture = document.querySelector("#mainPicture");
      const ingredientsList = document.querySelector("#ingredientsList");
      const recipeStepsContainer = document.querySelector("#recipeSteps");
      const totalTime = document.querySelector("#totalTime");
      const activeTime = document.querySelector("#activeTime");
      const dishType = document.querySelector("#dishType");
      const difficulty = document.querySelector("#difficulty");
      const commentText = document.querySelector("#commentText");
      const commentsList = document.querySelector("#commentsList");
      const submitCommentButton = document.querySelector("#submitCommentBtn");

      const urlParams = new URLSearchParams(window.location.search);
      const recipeId = parseInt(urlParams.get("id") || "1");

      fetch(`http://localhost/api/recipes/${recipeId}`, {
        method: "GET",
        headers: {
          accept: "application/json",
          "Content-Type": "application/json",
        },
      }).then((r) =>
        r.json().then((json) => {
          recipeTitle.innerHTML = json.title;
          mainPicture.src = json.picture;

          ingredientsList.innerHTML = "";
          json.ingredients.forEach((ingredient) => {
            ingredientsList.innerHTML += `<li><strong>${ingredient.ingredient.name}</strong> - ${ingredient.quantity} ${ingredient.unit}</li>`;
          });

          recipeStepsContainer.innerHTML = json.description;
          totalTime.innerHTML = `${json.cooking_time} –º–∏–Ω—É—Ç`;
          activeTime.innerHTML = `${json.preparation_time} –º–∏–Ω—É—Ç`;
          dishType.innerHTML = json.dish_type;
          difficulty.innerHTML = json.difficulty_level;
        })
      );
      fetch(`http://localhost/api/comments/recipe/${recipeId}`, {
        method: "GET",
        headers: {
          accept: "application/json",
          "Content-Type": "application/json",
        },
      }).then((r) =>
        r.json().then((json) => {
          commentsList.innerHTML = "";
          json.forEach(comment => {
            commentsList.innerHTML += `
            <div class="card w-100 mb-3" style="width: 18rem">
              <div class="card-body">
                <div class="d-flex mb-2">
                  <h5 class="card-title">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å #${comment.user_id}</h5>
                </div>
                <p class="card-text">${comment.text}</p>
              </div>
            </div>
            `;
          })
        })
      );

      submitCommentButton.addEventListener("click", (e) => {
        e.preventDefault();

        const access_token = localStorage.getItem("access_token");
        if (!access_token) return;

        const text = commentText.value.trim();
        if (text.length < 10) return;

        fetch(`http://localhost/api/comments`, {
          method: "POST",
          headers: {
            accept: "application/json",
            "Content-Type": "application/json",
            authorization: `Bearer ${access_token}`,
          },
          body: JSON.stringify({ recipe_id: recipeId, text }),
        }).then((r) =>
          r.json().then((json) => {
            commentsList.innerHTML += `
          <div class="card w-100 mb-4" style="width: 18rem">
            <div class="card-body">
              <div class="d-flex mb-2">
                <h5 class="card-title">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å #${json.user_id}</h5>
              </div>
              <p class="card-text">${json.text}</p>
            </div>
          </div>
          `;
          })
        );
      });
    </script>
  </body>
</html>
