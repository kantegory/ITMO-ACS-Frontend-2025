<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Поиск недвижимости — Площадь.ру</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="../css/style.css">
</head>
<body>

<div data-include="../component/navbar.html"></div>

<main class="py-4">
  <div class="container">
    <h1 class="h3 mb-4">Поиск недвижимости</h1>
    <form id="filterForm" class="row g-3 mb-4">
      <div class="col-md-3">
        <label class="form-label" for="location">Город/район</label>
        <input type="text" class="form-control" id="location" placeholder="Москва">
      </div>
      <div class="col-md-3">
        <label class="form-label" for="type">Тип объекта</label>
        <select id="type" class="form-select">
          <option value="">Любой</option>
          <option value="flat">Квартира</option>
          <option value="room">Комната</option>
          <option value="country-house">Дом</option>
        </select>
      </div>
      <div class="col-md-2">
        <label class="form-label" for="priceFrom">Цена от ₽</label>
        <input type="number" class="form-control" id="priceFrom" min="0">
      </div>
      <div class="col-md-2">
        <label class="form-label" for="priceTo">Цена до ₽</label>
        <input type="number" class="form-control" id="priceTo" min="0">
      </div>
      <div class="col-md-2 d-flex align-items-end">
        <button type="submit" class="btn btn-primary w-100">Применить</button>
      </div>
    </form>
    <div class="row g-4" id="results">
    </div>
  </div>
</main>
<div data-include="../component/contact-modal.html"></div>
<div data-include="../component/footer.html"></div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script type="module" src="../js/include.js"></script>

<script type="module">
  import { renderCards } from "../js/cards.js";
  import { API_BASE } from "../js/config.js";

  const form = document.getElementById("filterForm");
  const resultsContainer = document.getElementById("results");

  function mapLivingType(uiValue) {
    switch (uiValue) {
      case "flat": return "FLAT";
      case "room": return "ROOM";
      case "country-house": return "COUNTRY_HOUSE";
      default: return "";
    }
  }

  function buildSearchUrl() {
    const location = document.getElementById("location").value.trim();
    const typeUi = document.getElementById("type").value;
    const minPrice = document.getElementById("priceFrom").value;
    const maxPrice = document.getElementById("priceTo").value;

    const params = new URLSearchParams();
    if (location) params.set("location", location);

    const livingType = mapLivingType(typeUi);
    if (livingType) params.set("living_type", livingType);

    if (minPrice) params.set("min_price", String(Number(minPrice)));
    if (maxPrice) params.set("max_price", String(Number(maxPrice)));

    return `${API_BASE}/advertisements?${params.toString()}`;
  }

  async function loadAdverts() {
    if (resultsContainer) resultsContainer.innerHTML = "<p>Загружаем объявления...</p>";

    try {
      const url = buildSearchUrl();
      const response = await fetch(url);

      if (!response.ok) throw new Error(`Ошибка загрузки: ${response.status}`);

      const body = await response.json();
      const data = Array.isArray(body) ? body : body.content ?? [];

      const cards = data.map(advert => {
        const livingType = advert.property?.living?.livingType || "";
        const location = advert.property?.location || "";

        return {
          id: advert.id,
          type: livingType,
          price: advert.pricePerPeriod ?? 0,
          priceText: `${(advert.pricePerPeriod ?? 0).toLocaleString("ru-RU")} ₽/мес.`,
          location,
          title: advert.title || "Объявление",
          description: advert.description || "",
          image: advert.property?.photos?.[0]?.path || "https://picsum.photos/400/250",
        };
      });

      renderCards(cards);
    } catch (e) {
      console.error(e);
      if (resultsContainer) {
        resultsContainer.innerHTML =
          '<p class="text-danger">Не удалось загрузить объявления. Попробуйте обновить страницу позже.</p>';
      }
    }
  }

  document.addEventListener("DOMContentLoaded", () => {
    loadAdverts();

    form.addEventListener("submit", (e) => {
      e.preventDefault();
      loadAdverts();
    });
  });
</script>


<script type="module">
  import { renderCards } from "../js/cards.js";
  import { API_BASE } from "../js/config.js";

  const resultsContainer = document.getElementById('results');

  async function loadAdverts() {
    if (resultsContainer) {
      resultsContainer.innerHTML = '<p>Загружаем объявления...</p>';
    }

    try {
      const response = await fetch(`${API_BASE}/advertisements`);

      if (!response.ok) {
        throw new Error(`Ошибка загрузки: ${response.status}`);
      }
      const body = await response.json();
      const data = Array.isArray(body) ? body : body.content ?? [];
      const cards = data.map(advert => ({
        id: advert.id,
        type: advert.property?.livingType || '',
        price: advert.pricePerPeriod,
        priceText: `${(advert.pricePerPeriod ?? 0).toLocaleString('ru-RU')} ₽/мес.`,
        location: advert.property?.location || '',
        title: advert.title || advert.name || 'Объявление',
        description: advert.description || '',

        image:
          advert.property?.photos?.[0]?.path
          || 'https://picsum.photos/400/250'
      }));

      renderCards(cards);
    } catch (e) {
      console.error(e);
      if (resultsContainer) {
        resultsContainer.innerHTML =
          '<p class="text-danger">Не удалось загрузить объявления. Попробуйте обновить страницу позже.</p>';
      }
    }
  }

  document.addEventListener('DOMContentLoaded', loadAdverts);
</script>
</body>
</html>
