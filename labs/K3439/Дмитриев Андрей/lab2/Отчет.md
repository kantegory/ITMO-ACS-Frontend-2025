# Лабораторная работа 2: Взаимодействие с внешним API

**Студент:** Дмитриев Андрей Иванович
**Группа:** K3439 
**Вариант:** Платформа для образовательных курсов и управления учебным процессом

---

## 1. Описание задачи

В рамках второй лабораторной работы необходимо было интегрировать ранее разработанный интерфейс с backend API. Реализовать:
- Взаимодействие с REST API через Axios
- Систему аутентификации с cookie-based сессиями
- Обработку HTTP запросов и ошибок
- CRUD операции для всех основных сущностей

---

## 2. Архитектура API взаимодействия

### 2.1 Axios Instance (`src/api/axiosInstance.js`)

Создан централизованный экземпляр Axios с базовой конфигурацией:

```javascript
import axios from 'axios';

const api = axios.create({
  baseURL: process.env.REACT_APP_API_URL || '/api',
  withCredentials: true,   // для работы с HttpOnly cookies
  headers: {
    'Accept': 'application/json',
    'Content-Type': 'application/json',
  },
  timeout: 15000, // 15 секунд
});
```

**Особенности:**
- `withCredentials: true` - автоматическая отправка cookies с каждым запросом
- Динамическая базовая URL из переменных окружения
- Таймаут 15 секунд для предотвращения зависаний
- Автоматическая установка заголовков

---

### 2.2 Request Interceptor

Перехватчик запросов для логирования и обработки FormData:

```javascript
api.interceptors.request.use(
  config => {
    // Для FormData не устанавливаем Content-Type
    if (config.data instanceof FormData) {
      delete config.headers['Content-Type'];
    } else if (config.data && typeof config.data === 'object') {
      config.headers['Content-Type'] = 'application/json';
    }
    
    console.log('[API] Request:', {
      method: config.method,
      url: config.url,
      headers: config.headers,
      data: config.data instanceof FormData ? 'FormData' : config.data
    });
    return config;
  },
  error => {
    console.error('[API] Request error:', error);
    return Promise.reject(error);
  }
);
```

**Функции:**
- Автоматическое определение типа контента
- Логирование всех исходящих запросов
- Специальная обработка FormData для загрузки файлов

---

### 2.3 Response Interceptor

Перехватчик ответов для обработки ошибок:

```javascript
api.interceptors.response.use(
  res => {
    console.log('[API] Response:', {
      status: res.status,
      url: res.config.url,
      data: res.data
    });
    return res;
  },
  err => {
    console.error('[API] Response error:', {
      status: err.response?.status,
      url: err.config?.url,
      data: err.response?.data
    });
    return Promise.reject(err);
  }
);
```

---

## 3. Система аутентификации

### 3.1 AuthContext (`src/contexts/AuthContext.js`)

Контекст для управления состоянием аутентификации:

```javascript
export function AuthProvider({ children }) {
  const [user, setUser] = useState(undefined); // undefined - загрузка, null - не авторизован
  const [refreshing, setRefreshing] = useState(false);

  // Проверка сессии при загрузке
  useEffect(() => {
    api.get('/users/me')  
      .then(({ data }) => setUser(data))
      .catch(() => setUser(null));
  }, []);

  // Автоматическое обновление токена каждые 4 минуты
  useEffect(() => {
    if (user && !refreshing) {
      const id = setInterval(async () => {
        if (!refreshing) {
          setRefreshing(true);
          try {
            const { data } = await api.post('/users/refresh');
            setUser(data);
          } catch (err) {
            console.error('Token refresh failed:', err);
            if (err.response?.status === 401) {
              setUser(null);
            }
          } finally {
            setRefreshing(false);
          }
        }
      }, 4 * 60 * 1000);
      return () => clearInterval(id);
    }
  }, [user, refreshing]);

  const login = async (username, password) => {
    const { data } = await api.post('/users/auth', {
      username,
      password
    });
    setUser(data);
    return data;
  };

  const logout = async () => {
    try {
      await api.post('/users/logout');  
    } catch (err) {
      console.error('Logout error:', err);
    } finally {
      setUser(null);
    }
  };

  return (
    <AuthContext.Provider value={{ user, login, logout, updateUser }}>
      {children}
    </AuthContext.Provider>
  );
}
```

**Ключевые особенности:**
- Cookie-based аутентификация
- Автоматический refresh токена
- Проверка сессии при загрузке приложения
- Три состояния пользователя: undefined (загрузка), null (не авторизован), object (авторизован)

---

### 3.2 Защищённые маршруты

```javascript
function PrivateRoute({ children }) {
  const { user } = useAuth();
  
  if (user === undefined) {
    return <div>Загрузка...</div>;
  }
  
  if (user === null) {
    return <Navigate to="/login" />;
  }
  
  return children;
}
```

---

## 4. Service-слой для API

### 4.1 User Service (`src/services/userService.js`)

```javascript
const userService = {
  // Получить текущего пользователя
  async getMe() {
    const { data } = await api.get('/users/me');
    return data;
  },

  // Обновить профиль
  async updateProfile(userData) {
    const { data } = await api.patch('/users/me', userData);
    return data;
  },

  // Загрузить аватар
  async uploadAvatar(file) {
    const formData = new FormData();
    formData.append('file', file);
    const { data } = await api.post('/users/me/avatar', formData);
    return data;
  },

  // Изменить пароль
  async changePassword(oldPassword, newPassword) {
    const { data } = await api.post('/users/change-password', {
      old_password: oldPassword,
      new_password: newPassword
    });
    return data;
  }
};
```

---

### 4.2 Course Service (`src/services/courseService.js`)

Полный CRUD для курсов:

```javascript
const courseService = {
  // Получить список курсов студента
  async listStudentCourses() {
    const { data } = await api.get('/courses/student');
    return data;
  },

  // Получить все курсы с фильтрацией
  async getAllCoursesFiltered(user, limit = 100, offset = 0) {
    const { data } = await api.get('/courses/', {
      params: { limit, offset }
    });
    return data;
  },

  // Получить детали курса
  async getCourseDetails(courseId) {
    const { data } = await api.get(`/courses/${courseId}`);
    return data;
  },

  // Получить прогресс студента по урокам
  async getStudentLessonProgress() {
    const { data } = await api.get('/lesson-groups/student/progress');
    return data;
  },

  // Создать курс (для администратора)
  async createCourse(courseData) {
    const { data } = await api.post('/courses/', courseData);
    return data;
  },

  // Обновить курс
  async updateCourse(courseId, courseData) {
    const { data } = await api.patch(`/courses/${courseId}`, courseData);
    return data;
  },

  // Удалить курс
  async deleteCourse(courseId) {
    await api.delete(`/courses/${courseId}`);
  }
};
```

---

### 4.3 Schedule Service (`src/services/scheduleService.js`)

```javascript
export async function getUserScheduleOptimized(user) {
  if (!user) return [];

  try {
    let events = [];

    if (user.role === 'student') {
      // Получаем расписание студента
      const { data } = await api.get('/lesson-groups/student/schedule');
      events = data.map(item => ({
        id: item.id,
        title: item.lesson?.course?.name || 'Занятие',
        start: item.start_time,
        end: item.end_time,
        courseId: item.lesson?.course_id,
        lessonId: item.lesson_id,
        groupId: item.group_id,
        type: 'lesson'
      }));
    } else if (user.role === 'teacher') {
      // Получаем расписание преподавателя
      const { data } = await api.get('/lesson-groups/teacher/schedule');
      events = data.map(item => ({
        id: item.id,
        title: item.lesson?.course?.name || 'Занятие',
        start: item.start_time,
        end: item.end_time,
        courseId: item.lesson?.course_id,
        lessonId: item.lesson_id,
        groupId: item.group_id,
        type: 'lesson'
      }));
    }

    return events;
  } catch (error) {
    console.error('[Schedule] Error loading schedule:', error);
    return [];
  }
}
```

---

### 4.4 Homework Service (`src/services/homeworkService.js`)

```javascript
const homeworkService = {
  // Получить домашние задания студента
  async getStudentHomeworks() {
    const { data } = await api.get('/homeworks/student');
    return data;
  },

  // Отправить решение
  async submitHomework(homeworkId, formData) {
    const { data } = await api.post(
      `/homeworks/${homeworkId}/submit`, 
      formData
    );
    return data;
  },

  // Получить решения для проверки (преподаватель)
  async getHomeworksToCheck() {
    const { data } = await api.get('/homeworks/teacher/to-check');
    return data;
  },

  // Проверить работу
  async checkHomework(submissionId, grade, feedback) {
    const { data } = await api.post(
      `/homework-submissions/${submissionId}/check`,
      { grade, feedback }
    );
    return data;
  }
};
```

---

### 4.5 Product Service (`src/services/productService.js`)

```javascript
const productService = {
  // Получить список товаров
  async getProducts() {
    const { data } = await api.get('/products/');
    return data;
  },

  // Купить товар
  async purchaseProduct(productId) {
    const { data } = await api.post(`/products/${productId}/purchase`);
    return data;
  },

  // История покупок
  async getPurchaseHistory() {
    const { data } = await api.get('/products/purchases/history');
    return data;
  }
};
```

---

### 4.6 Notification Service (`src/services/notificationService.js`)

```javascript
const notificationService = {
  // Получить уведомления
  async getNotifications() {
    const { data } = await api.get('/notifications/');
    return data;
  },

  // Отметить как прочитанное
  async markAsRead(notificationId) {
    await api.patch(`/notifications/${notificationId}/read`);
  },

  // Отметить все как прочитанные
  async markAllAsRead() {
    await api.post('/notifications/mark-all-read');
  }
};
```

---

## 5. Обработка ошибок

### 5.1 Обработка на уровне компонентов

```javascript
const [error, setError] = useState(null);
const [loading, setLoading] = useState(true);

useEffect(() => {
  (async () => {
    try {
      setLoading(true);
      const data = await courseService.listStudentCourses();
      setCourses(data);
      setError(null);
    } catch (err) {
      console.error('[Component] Error:', err);
      if (!err.response) {
        setError('Сервер недоступен');
      } else if (err.response.status === 404) {
        setError('Данные не найдены');
      } else if (err.response.status === 401) {
        setError('Требуется авторизация');
      } else {
        setError(err.response.data.detail || 'Произошла ошибка');
      }
    } finally {
      setLoading(false);
    }
  })();
}, []);
```

---

### 5.2 Пользовательские уведомления (Toast)

```javascript
import { toast } from 'react-toastify';

try {
  await courseService.createCourse(courseData);
  toast.success('Курс успешно создан');
} catch (error) {
  toast.error('Ошибка при создании курса');
}
```

---

## 6. Интеграция API в компоненты

### 6.1 Пример: StudentCoursesPage

```javascript
export default function StudentCoursesPage() {
  const { user } = useAuth();
  const [myCourses, setMyCourses] = useState([]);
  const [otherCourses, setOtherCourses] = useState([]);
  const [lessonProgress, setLessonProgress] = useState([]);
  const [loading, setLoading] = useState(true);

  useEffect(() => {
    (async () => {
      try {
        setLoading(true);
        
        // 1. Загружаем доступные курсы студента
        const availableCourses = await listStudentCourses();
        const availableIds = new Set(availableCourses.map(c => c.id));
        setMyCourses(availableCourses || []);
        
        // 2. Загружаем прогресс по урокам
        const lessonProgressData = await getStudentLessonProgress();
        setLessonProgress(lessonProgressData || []);
        
        // 3. Загружаем все курсы с фильтрацией
        const allCoursesResponse = await getAllCoursesFiltered(user, 100, 0);
        const allCourses = allCoursesResponse.objects || [];
        const unavailableCourses = allCourses.filter(c => !availableIds.has(c.id));
        setOtherCourses(unavailableCourses);
      } catch (err) {
        console.error('Error loading courses:', err);
      } finally {
        setLoading(false);
      }
    })();
  }, [user]);

  // Render...
}
```

---

### 6.2 Пример: LoginPage с API

```javascript
const handleSubmit = async (e) => {
  e.preventDefault();
  setToast({ message: '', type: 'error' });
  
  try {
    await login(username, password);
    navigate('/home', { replace: true });
  } catch (err) {
    let msg = 'Неизвестная ошибка';
    
    if (!err.response) {
      msg = 'Сервер недоступен или CORS.';
    } else if (err.response.status === 404) {
      msg = 'Пользователь не найден';
    } else if (err.response.status === 401) {
      msg = 'Неверный логин или пароль';
    } else {
      const detail = err.response.data.detail;
      if (Array.isArray(detail)) {
        msg = detail.map(i => i.msg).join('; ');
      } else if (typeof detail === 'string') {
        msg = detail;
      }
    }
    
    setToast({ message: msg, type: 'error' });
  }
};
```

---

### 6.3 Пример: HomePage с множественными API запросами

```javascript
export default function HomePage() {
  const { user } = useAuth();
  const [fullUser, setFull] = useState(null);
  const [studentData, setStudentData] = useState(null);
  const [events, setEv] = useState([]);
  const [news, setNews] = useState([]);

  // Загрузка профиля
  useEffect(() => {
    if (!user) return;
    userService.getMe()
      .then(setFull)
      .catch(() => navigate('/login', { replace: true }));
  }, [user]);

  // Загрузка данных студента с монетами
  useEffect(() => {
    if (!user || user.role !== 'student') return;

    const loadStudentData = async () => {
      try {
        const response = await api.get('/students/me');
        setStudentData(response.data);
      } catch (error) {
        console.error('Error loading student data:', error);
      }
    };

    loadStudentData();
  }, [user]);

  // Загрузка расписания
  useEffect(() => {
    if (!user) return;
    (async () => {
      try {
        setEv(await getUserScheduleOptimized(user));
      } catch {
        console.error('schedule fetch error');
      }
    })();
  }, [user]);

  // Загрузка новостей
  useEffect(() => {
    api.get('/news/')
      .then(response => {
        const arr = response.data;
        arr.sort((a, b) => new Date(b.created_at) - new Date(a.created_at));
        setNews(arr);
      })
      .catch(err => console.error('news fetch error', err));
  }, []);

  // Render...
}
```

---

## 7. Загрузка файлов (File Upload)

### 7.1 Загрузка аватара

```javascript
const handleAvatarUpload = async (file) => {
  const formData = new FormData();
  formData.append('file', file);

  try {
    const result = await userService.uploadAvatar(formData);
    toast.success('Аватар успешно обновлён');
    await updateUser();
  } catch (error) {
    toast.error('Ошибка при загрузке аватара');
  }
};
```

---

### 7.2 Загрузка материалов урока

```javascript
const uploadMaterial = async (lessonId, file, type) => {
  const formData = new FormData();
  formData.append('file', file);
  formData.append('type', type);

  try {
    const { data } = await api.post(
      `/lessons/${lessonId}/materials`,
      formData
    );
    return data;
  } catch (error) {
    console.error('Error uploading material:', error);
    throw error;
  }
};
```

---

## 8. Pagination и фильтрация

### 8.1 Пагинация курсов

```javascript
const [page, setPage] = useState(0);
const [limit] = useState(20);
const [total, setTotal] = useState(0);

useEffect(() => {
  (async () => {
    try {
      const response = await getAllCoursesFiltered(user, limit, page * limit);
      setCourses(response.objects);
      setTotal(response.total);
    } catch (error) {
      console.error('Error loading courses:', error);
    }
  })();
}, [page, limit, user]);

const handleNextPage = () => {
  if ((page + 1) * limit < total) {
    setPage(page + 1);
  }
};

const handlePrevPage = () => {
  if (page > 0) {
    setPage(page - 1);
  }
};
```

---

### 8.2 Фильтрация и поиск

```javascript
const [searchQuery, setSearchQuery] = useState('');
const [filters, setFilters] = useState({
  category: 'all',
  ageGroup: 'all'
});

const filteredCourses = useMemo(() => {
  return courses.filter(course => {
    const matchesSearch = course.name.toLowerCase()
      .includes(searchQuery.toLowerCase());
    
    const matchesCategory = filters.category === 'all' || 
      course.category === filters.category;
    
    const matchesAge = filters.ageGroup === 'all' || 
      course.age_category.includes(filters.ageGroup);
    
    return matchesSearch && matchesCategory && matchesAge;
  });
}, [courses, searchQuery, filters]);
```

---

## 9. Real-time обновления

### 9.1 Периодическое обновление данных

```javascript
useEffect(() => {
  // Начальная загрузка
  loadNotifications();

  // Обновление каждые 30 секунд
  const interval = setInterval(() => {
    loadNotifications();
  }, 30000);

  return () => clearInterval(interval);
}, []);

const loadNotifications = async () => {
  try {
    const data = await notificationService.getNotifications();
    setNotifications(data);
  } catch (error) {
    console.error('Error loading notifications:', error);
  }
};
```

---

## 10. Переменные окружения

Файл `.env`:
```
REACT_APP_API_URL=http://localhost:8000/api
REACT_APP_ENVIRONMENT=development
```

Использование в коде:
```javascript
const API_URL = process.env.REACT_APP_API_URL || '/api';
const IS_DEV = process.env.REACT_APP_ENVIRONMENT === 'development';
```

---

## 11. Тестирование API интеграции

### 11.1 Проверка доступности API

```javascript
export async function testApiConnection() {
  try {
    const response = await api.get('/health');
    console.log('API is available:', response.data);
    return true;
  } catch (error) {
    console.error('API is not available:', error);
    return false;
  }
}
```

---

### 11.2 Компонент диагностики API

```jsx
export default function ApiDiagnostics() {
  const [status, setStatus] = useState('checking');

  useEffect(() => {
    (async () => {
      const isAvailable = await testApiConnection();
      setStatus(isAvailable ? 'online' : 'offline');
    })();
  }, []);

  return (
    <div className={`api-status ${status}`}>
      API Status: {status}
    </div>
  );
}
```

---

## 12. Реализованные API эндпоинты

### Аутентификация:
- `POST /users/auth` - вход
- `POST /users/logout` - выход
- `POST /users/refresh` - обновление токена
- `GET /users/me` - текущий пользователь

### Пользователи:
- `PATCH /users/me` - обновление профиля
- `POST /users/me/avatar` - загрузка аватара
- `POST /users/change-password` - смена пароля

### Курсы:
- `GET /courses/` - список курсов
- `GET /courses/{id}` - детали курса
- `GET /courses/student` - курсы студента
- `POST /courses/` - создание курса
- `PATCH /courses/{id}` - обновление курса
- `DELETE /courses/{id}` - удаление курса

### Уроки:
- `GET /lessons/{id}` - детали урока
- `POST /lessons/` - создание урока
- `PATCH /lessons/{id}` - обновление урока
- `POST /lessons/{id}/materials` - загрузка материалов

### Группы уроков (Расписание):
- `GET /lesson-groups/student/schedule` - расписание студента
- `GET /lesson-groups/teacher/schedule` - расписание преподавателя
- `GET /lesson-groups/student/progress` - прогресс студента

### Домашние задания:
- `GET /homeworks/student` - задания студента
- `POST /homeworks/{id}/submit` - отправка решения
- `GET /homeworks/teacher/to-check` - задания на проверку
- `POST /homework-submissions/{id}/check` - проверка работы

### Магазин:
- `GET /products/` - список товаров
- `POST /products/{id}/purchase` - покупка товара
- `GET /products/purchases/history` - история покупок

### Уведомления:
- `GET /notifications/` - список уведомлений
- `PATCH /notifications/{id}/read` - отметить прочитанным
- `POST /notifications/mark-all-read` - отметить все

### Новости:
- `GET /news/` - список новостей
- `POST /news/` - создание новости
- `PATCH /news/{id}` - обновление новости

### Рейтинг:
- `GET /students/rating` - рейтинг студентов
- `GET /students/me` - данные студента с баллами

---

## 13. Выводы

В ходе выполнения второй лабораторной работы были получены следующие навыки:

1. **Axios** - настройка HTTP клиента с интерцепторами
2. **REST API** - взаимодействие с RESTful API
3. **Аутентификация** - реализация cookie-based авторизации с автообновлением токенов
4. **Service Layer** - создание слоя абстракции для API запросов
5. **Error Handling** - обработка ошибок HTTP запросов
6. **File Upload** - загрузка файлов через FormData
7. **Context API** - управление глобальным состоянием аутентификации
8. **Асинхронность** - работа с async/await и Promise


**Дата выполнения:** 21.01.2026
