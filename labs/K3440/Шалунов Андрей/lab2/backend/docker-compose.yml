version: '3.8'

services:
  rabbitmq:
    image: rabbitmq:3-management-alpine
    ports:
      - '5672:5672'
      - '15672:15672'
    environment:
      RABBITMQ_DEFAULT_USER: guest
      RABBITMQ_DEFAULT_PASS: guest
    restart: always

  auth-db:
    image: postgres:13-alpine
    environment:
      POSTGRES_DB: auth_db
      POSTGRES_USER: test
      POSTGRES_PASSWORD: test
    volumes:
      - auth-db-data:/var/lib/postgresql/data
    restart: always

  user-db:
    image: postgres:13-alpine
    environment:
      POSTGRES_DB: user_db
      POSTGRES_USER: test
      POSTGRES_PASSWORD: test
    volumes:
      - user-db-data:/var/lib/postgresql/data
    restart: always

  property-db:
    image: postgres:13-alpine
    environment:
      POSTGRES_DB: property_db
      POSTGRES_USER: test
      POSTGRES_PASSWORD: test
    volumes:
      - property-db-data:/var/lib/postgresql/data
    restart: always

  photo-db:
    image: postgres:13-alpine
    environment:
      POSTGRES_DB: photo_db
      POSTGRES_USER: test
      POSTGRES_PASSWORD: test
    volumes:
      - photo-db-data:/var/lib/postgresql/data
    restart: always

  booking-db:
    image: postgres:13-alpine
    environment:
      POSTGRES_DB: booking_db
      POSTGRES_USER: test
      POSTGRES_PASSWORD: test
    volumes:
      - booking-db-data:/var/lib/postgresql/data
    restart: always

  message-db:
    image: postgres:13-alpine
    environment:
      POSTGRES_DB: message_db
      POSTGRES_USER: test
      POSTGRES_PASSWORD: test
    volumes:
      - message-db-data:/var/lib/postgresql/data
    restart: always

  auth-service:
    build:
      context: ./auth-service
      args:
        PORT: 3000
    env_file:
      - ./auth-service/.env
    ports:
      - '3000:3000'
    volumes:
      - ./auth-service/src:/app/src
      - ./auth-service/tsconfig.json:/app/tsconfig.json
      - ./auth-service/package.json:/app/package.json
    depends_on:
      - auth-db
    restart: always

  user-service:
    build:
      context: ./user-service
      args:
        PORT: 3001
    env_file:
      - ./user-service/.env
    environment:
      AMQP_URL: amqp://rabbitmq:5672
    ports:
      - '3001:3001'
    volumes:
      - ./user-service/src:/app/src
      - ./user-service/tsconfig.json:/app/tsconfig.json
      - ./user-service/package.json:/app/package.json
    depends_on:
      - user-db
      - rabbitmq
    restart: always

  property-service:
    build:
      context: ./property-service
      args:
        PORT: 3002
    env_file:
      - ./property-service/.env
    ports:
      - '3002:3002'
    volumes:
      - ./property-service/src:/app/src
      - ./property-service/tsconfig.json:/app/tsconfig.json
      - ./property-service/package.json:/app/package.json
    depends_on:
      - property-db
    restart: always

  photo-service:
    build:
      context: ./photo-service
      args:
        PORT: 3003
    env_file:
      - ./photo-service/.env
    ports:
      - '3003:3003'
    volumes:
      - ./photo-service/src:/app/src
      - ./photo-service/tsconfig.json:/app/tsconfig.json
      - ./photo-service/package.json:/app/package.json
    depends_on:
      - photo-db
    restart: always

  booking-service:
    build:
      context: ./booking-service
      args:
        PORT: 3004
    env_file:
      - ./booking-service/.env
    environment:
      AMQP_URL: amqp://rabbitmq:5672
    ports:
      - '3004:3004'
    volumes:
      - ./booking-service/src:/app/src
      - ./booking-service/tsconfig.json:/app/tsconfig.json
      - ./booking-service/package.json:/app/package.json
    depends_on:
      - booking-db
      - user-service
      - rabbitmq
    restart: always

  message-service:
    build:
      context: ./message-service
      args:
        PORT: 3005
    env_file:
      - ./message-service/.env
    environment:
      AMQP_URL: amqp://rabbitmq:5672
    ports:
      - '3005:3005'
    volumes:
      - ./message-service/src:/app/src
      - ./message-service/tsconfig.json:/app/tsconfig.json
      - ./message-service/package.json:/app/package.json
    depends_on:
      - message-db
      - user-service
      - rabbitmq
    restart: always

  api-gateway:
    build:
      context: ./api-gateway
      args:
        PORT: 8000
    env_file:
      - ./api-gateway/.env
    ports:
      - '8000:8000'
    volumes:
      - ./api-gateway/src:/app/src
      - ./api-gateway/tsconfig.json:/app/tsconfig.json
      - ./api-gateway/package.json:/app/package.json
    depends_on:
      - auth-service
      - user-service
      - property-service
      - photo-service
      - booking-service
      - message-service
    restart: always

volumes:
  auth-db-data:
  user-db-data:
  property-db-data:
  photo-db-data:
  booking-db-data:
  message-db-data: