<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1"/>
    <title>FRESH — Платформа фитнеса</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet"/>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet"/>
    <style>
        :root {
            --primary: #6366f1;
            --secondary: #8b5cf6;
            --bg: #f8fafc;
            --text: #1e293b;
            --sidebar-w: 280px;
        }

        html, body {
            height: 100%;
            margin: 0;
            background: var(--bg);
            color: var(--text);
            font-family: system-ui, -apple-system, 'Segoe UI', Roboto, Arial, sans-serif
        }

        .sidebar {
            width: var(--sidebar-w);
            min-height: 100vh;
            position: fixed;
            left: 0;
            top: 0;
            background: #111827;
            color: #fff;
            box-shadow: 2px 0 10px rgba(0, 0, 0, .12);
            z-index: 1000;
        }

        .sidebar .nav-link {
            color: #fff;
            opacity: .9;
            border-radius: .5rem;
            padding: .75rem 1rem
        }

        .sidebar .nav-link.active {
            background: var(--primary)
        }

        .sidebar .nav-link:hover {
            background: rgba(255, 255, 255, .1)
        }

        .main {
            margin-left: var(--sidebar-w);
            padding: 1.5rem
        }

        .page {
            display: none
        }

        .page.active {
            display: block
        }

        .card {
            border: none;
            border-radius: 1rem;
            box-shadow: 0 4px 12px rgba(0, 0, 0, .08);
            transition: transform .3s ease, box-shadow .3s ease;
        }

        .card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, .12);
        }

        .hero {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: #fff;
            padding: 3rem;
            border-radius: 1rem
        }

        .blog-card img {
            height: 200px;
            object-fit: cover;
        }

        .badge-category {
            position: absolute;
            top: 10px;
            right: 10px;
            z-index: 1;
        }

        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(99, 102, 241, 0.3);
            border-radius: 50%;
            border-top-color: var(--primary);
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

    </style>
</head>
<body>
<aside class="sidebar" id="sidebar">
    <div class="p-3 text-center">
        <div class="h4 fw-bold">FRESH</div>
        <div class="small text-white-50">Fitness & Health</div>
    </div>
    <nav class="nav flex-column px-2" id="mainNav">
        <a class="nav-link active" href="#" data-page="home" data-auth="any">
            <i class="bi bi-house-door me-2"></i>Главная
        </a>
        <a class="nav-link" href="#" data-page="search" data-auth="any">
            <i class="bi bi-search me-2"></i>Поиск
        </a>
        <a class="nav-link" href="#" data-page="blog" data-auth="any">
            <i class="bi bi-newspaper me-2"></i>Блог
        </a>
        <a class="nav-link" href="#" data-page="dashboard" data-auth="auth">
            <i class="bi bi-speedometer2 me-2"></i>Кабинет
        </a>
        <a class="nav-link" href="#" data-page="login" data-auth="guest">
            <i class="bi bi-box-arrow-in-right me-2"></i>Вход
        </a>
        <button class="btn btn-primary mt-3 w-100" data-page="register" data-auth="guest" type="button">
            Регистрация
        </button>
        <button class="btn btn-outline-light mt-3 w-100" id="logoutBtn" data-auth="auth" type="button">
            <i class="bi bi-box-arrow-right me-2"></i>Выход
        </button>
    </nav>
</aside>

<main class="main">
    <section id="home" class="page">
        <div class="hero mb-4">
            <h1 class="h3 fw-bold">Путь к здоровому образу жизни</h1>
            <p class="text-white-50">Тренировки, прогресс и планирование.</p>
            <a href="#" class="btn btn-light me-2" data-page="search">Начать</a>
            <a href="#" class="btn btn-outline-light" data-page="blog">Читать блог</a>
        </div>
    </section>

    <section id="login" class="page">
        <div class="card p-4" style="max-width:420px">
            <h2 class="h5 mb-3">Вход</h2>
            <form id="loginForm">
                <input id="loginEmail" type="email" class="form-control mb-2" placeholder="Email" required>
                <input id="loginPassword" type="password" class="form-control mb-3" placeholder="Пароль" required>
                <button class="btn btn-primary w-100" type="submit">
                    <span class="btn-text">Войти</span>
                    <span class="btn-spinner d-none"><span class="loading-spinner"></span> Загрузка...</span>
                </button>
            </form>
            <div class="mt-3 small text-muted">
                <i class="bi bi-info-circle me-1"></i>Тестовый аккаунт: test@example.com / 123456
            </div>
        </div>
    </section>

    <section id="register" class="page">
        <div class="card p-4" style="max-width:480px">
            <h2 class="h5 mb-3">Регистрация</h2>
            <form id="registrationForm">
                <input id="regName" type="text" class="form-control mb-2" placeholder="Имя" required>
                <input id="regEmail" type="email" class="form-control mb-2" placeholder="Email" required>
                <input id="regPassword" type="password" class="form-control mb-2" placeholder="Пароль" required>
                <input id="regPasswordConfirm" type="password" class="form-control mb-3" placeholder="Повторите пароль"
                       required>
                <button class="btn btn-primary w-100" type="submit">Создать аккаунт</button>
            </form>
        </div>
    </section>

    <section id="dashboard" class="page">
        <div class="mb-4">
            <h2 class="h3 fw-bold mb-1">
                <i class="bi bi-person-circle text-primary me-2"></i>Личный Кабинет
            </h2>
            <p class="text-muted">Добро пожаловать, <span id="userNameDisplay" class="fw-semibold">Пользователь</span>
            </p>
        </div>
        <div class="row g-4">
            <div class="col-lg-6">
                <div class="card p-4 h-100">
                    <h4 class="fw-bold mb-3"><i class="bi bi-graph-up me-2 text-success"></i>Трекинг Прогресса</h4>
                    <ul class="list-group list-group-flush">
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            Вес: 75 кг <span class="badge bg-success">↓ -1.5 кг</span>
                        </li>
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            Тренировок за неделю: 4 <span class="badge bg-primary">+1</span>
                        </li>
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            Цель: 50 отжиманий <span class="badge bg-warning text-dark">35/50</span>
                        </li>
                    </ul>
                    <button class="btn btn-outline-success mt-3">Обновить данные</button>
                </div>
            </div>
            <div class="col-lg-6">
                <div class="card p-4 h-100">
                    <h4 class="fw-bold mb-3"><i class="bi bi-calendar-check me-2 text-primary"></i>Твой План Тренировок
                    </h4>
                    <div class="accordion" id="trainingPlanAccordion">
                        <div class="accordion-item">
                            <h2 class="accordion-header" id="headingOne">
                                <button class="accordion-button" type="button" data-bs-toggle="collapse"
                                        data-bs-target="#collapseOne" aria-expanded="true" aria-controls="collapseOne">
                                    Понедельник: Силовая (Грудь/Спина)
                                </button>
                            </h2>
                            <div id="collapseOne" class="accordion-collapse collapse show" aria-labelledby="headingOne"
                                 data-bs-parent="#trainingPlanAccordion">
                                <div class="accordion-body">
                                    Жим лежа (3x10), Тяга блока (3x12), Отжимания (до отказа).
                                </div>
                            </div>
                        </div>
                        <div class="accordion-item">
                            <h2 class="accordion-header" id="headingTwo">
                                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse"
                                        data-bs-target="#collapseTwo" aria-expanded="false" aria-controls="collapseTwo">
                                    Среда: Кардио (Бег 5 км)
                                </button>
                            </h2>
                            <div id="collapseTwo" class="accordion-collapse collapse" aria-labelledby="headingTwo"
                                 data-bs-parent="#trainingPlanAccordion">
                                <div class="accordion-body">
                                    Разминка 10 мин, Бег 5 км в среднем темпе, Заминка 5 мин.
                                </div>
                            </div>
                        </div>
                    </div>
                    <button class="btn btn-primary mt-3">Изменить план</button>
                </div>
            </div>
        </div>
    </section>

    <section id="search" class="page">
        <h2 class="h5 mb-3">Тренировки</h2>
        <div class="row g-4">
            <aside class="col-md-4">
                <div class="card p-3">
                    <h3 class="h6">Фильтр</h3>
                    <div class="mb-2">
                        <label class="form-label small">Уровень</label>
                        <select id="filterLevel" class="form-select form-select-sm">
                            <option value="">Все</option>
                            <option value="beginner">Начинающий</option>
                            <option value="advanced">Продвинутый</option>
                        </select>
                    </div>
                    <div class="mb-2">
                        <label class="form-label small">Тип</label>
                        <select id="filterType" class="form-select form-select-sm">
                            <option value="">Все</option>
                            <option value="cardio">Кардио</option>
                            <option value="strength">Силовая</option>
                        </select>
                    </div>
                    <div class="mb-2">
                        <label class="form-label small">Длительность ≤ <span id="durationValue">60</span> мин</label>
                        <input id="filterDuration" type="range" min="10" max="120" step="5" value="60"
                               class="form-range">
                    </div>
                    <button id="applyFiltersBtn" class="btn btn-sm btn-primary w-100" type="button">Применить</button>
                </div>
            </aside>
            <div class="col-md-8" id="trainingResults">
                <div class="text-center p-4">
                    <span class="loading-spinner"></span>
                    <p class="mt-2 text-muted">Загрузка тренировок...</p>
                </div>
            </div>
        </div>
    </section>

    <section id="blog" class="page">
        <div class="mb-4">
            <h2 class="h3 fw-bold mb-2">
                <i class="bi bi-newspaper text-primary me-2"></i>Блог о Здоровье и Питании
            </h2>
            <p class="text-muted">Полезные статьи, советы и исследования для вашего фитнес-путешествия</p>
        </div>
        <div class="card p-3 mb-4">
            <div class="row g-2 align-items-end">
                <div class="col-md-4">
                    <label class="form-label small mb-1">Категория</label>
                    <select id="blogCategoryFilter" class="form-select form-select-sm">
                        <option value="">Все категории</option>
                        <option value="nutrition">Питание</option>
                        <option value="training">Тренировки</option>
                        <option value="health">Здоровье</option>
                        <option value="recovery">Восстановление</option>
                    </select>
                </div>
                <div class="col-md-4">
                    <label class="form-label small mb-1">Поиск</label>
                    <input type="text" id="blogSearchInput" class="form-control form-control-sm"
                           placeholder="Введите ключевое слово...">
                </div>
                <div class="col-md-4">
                    <button id="applyBlogFilters" class="btn btn-sm btn-primary w-100" type="button">
                        <i class="bi bi-funnel me-1"></i>Применить
                    </button>
                </div>
            </div>
        </div>
        <div class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-4" id="blogPostsContainer">
            <div class="col blog-post" data-category="nutrition">
                <div class="card h-100 blog-card position-relative">
                    <span class="badge bg-success badge-category">Питание</span>
                    <img src="https://placehold.co/600x400/1abc9c/ffffff?text=Питание" class="card-img-top"
                         alt="Питание">
                    <div class="card-body">
                        <h5 class="card-title">Топ-5 продуктов для энергии</h5>
                        <p class="card-text text-muted small">Узнайте, какие продукты помогут вам восстановиться после
                            интенсивных тренировок и обеспечат энергией на весь день.</p>
                        <div class="d-flex justify-content-between align-items-center mt-3">
                            <small class="text-muted">
                                <i class="bi bi-calendar3 me-1"></i>15.12.2024
                            </small>
                            <a href="#" class="btn btn-sm btn-outline-primary blog-read-btn"
                               data-title="Топ-5 продуктов для энергии"
                               data-content="Правильное питание — основа успешных тренировок. В этой статье мы расскажем о пяти продуктах, которые обеспечат вас энергией...">
                                Читать <i class="bi bi-arrow-right"></i>
                            </a>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col blog-post" data-category="training">
                <div class="card h-100 blog-card position-relative">
                    <span class="badge bg-primary badge-category">Тренировки</span>
                    <img src="https://placehold.co/600x400/3498db/ffffff?text=Тренировка" class="card-img-top"
                         alt="Тренировка">
                    <div class="card-body">
                        <h5 class="card-title">Идеальный план кардио на 30 дней</h5>
                        <p class="card-text text-muted small">Пошаговое руководство для улучшения выносливости и
                            сжигания жира с помощью эффективных кардио-тренировок.</p>
                        <div class="d-flex justify-content-between align-items-center mt-3">
                            <small class="text-muted">
                                <i class="bi bi-calendar3 me-1"></i>14.12.2024
                            </small>
                            <a href="#" class="btn btn-sm btn-outline-primary blog-read-btn"
                               data-title="Идеальный план кардио на 30 дней"
                               data-content="30-дневный план кардио-тренировок для начинающих и продвинутых спортсменов. Улучшите свою выносливость...">
                                Читать <i class="bi bi-arrow-right"></i>
                            </a>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col blog-post" data-category="recovery">
                <div class="card h-100 blog-card position-relative">
                    <span class="badge bg-info badge-category">Восстановление</span>
                    <img src="https://placehold.co/600x400/9b59b6/ffffff?text=Здоровье" class="card-img-top"
                         alt="Здоровье">
                    <div class="card-body">
                        <h5 class="card-title">Важность сна для восстановления мышц</h5>
                        <p class="card-text text-muted small">Почему качественный сон — ключ к фитнес-успеху и как
                            оптимизировать режим отдыха.</p>
                        <div class="d-flex justify-content-between align-items-center mt-3">
                            <small class="text-muted">
                                <i class="bi bi-calendar3 me-1"></i>13.12.2024
                            </small>
                            <a href="#" class="btn btn-sm btn-outline-primary blog-read-btn"
                               data-title="Важность сна для восстановления мышц"
                               data-content="Сон играет критическую роль в восстановлении после тренировок. Узнайте, как улучшить качество сна...">
                                Читать <i class="bi bi-arrow-right"></i>
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>
</main>

<div class="modal fade" id="trainingDetailModal" tabindex="-1">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalTrainingTitle">Тренировка</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="ratio ratio-16x9">
                    <iframe id="trainingVideo" src="" allowfullscreen></iframe>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="blogPostModal" tabindex="-1">
    <div class="modal-dialog modal-lg modal-dialog-centered modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="blogPostTitle">Статья</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p id="blogPostContent" class="lead"></p>
                <hr>
                <p class="text-muted">Тренируйся!</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Закрыть</button>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
    const API_BASE = 'http://localhost:3000';

    const QS = (s, r = document) => r.querySelector(s);
    const QSA = (s, r = document) => Array.from(r.querySelectorAll(s));

    function getToken() {
        return localStorage.getItem('token');
    }

    function getUser() {
        try {
            return JSON.parse(localStorage.getItem('user'));
        } catch {
            return null;
        }
    }

    function setAuth(token, user) {
        localStorage.setItem('token', token);
        localStorage.setItem('user', JSON.stringify(user));
    }

    function clearAuth() {
        localStorage.removeItem('token');
        localStorage.removeItem('user');
    }

    async function apiFetch(path, options = {}) {
        try {
            const res = await fetch(API_BASE + path, {
                ...options,
                headers: {
                    'Content-Type': 'application/json',
                    ...options.headers
                }
            });
            if (!res.ok) throw new Error('API error');
            return await res.json();
        } catch (error) {
            console.error('API Error:', error);
            throw error;
        }
    }

    function updateNav() {
        const isAuth = !!getToken();
        QSA('[data-auth]').forEach(el => {
            const m = el.dataset.auth;
            el.style.display = (m === 'any' || (m === 'auth' && isAuth) || (m === 'guest' && !isAuth)) ? '' : 'none';
        });
    }

    function showPage(id) {
        QSA('.page').forEach(p => p.classList.remove('active'));
        QS('#' + id)?.classList.add('active');
        QSA('[data-page]').forEach(l => l.classList.toggle('active', l.dataset.page === id));

        if (id === 'search') {
            loadTrainings();
        }
    }

    async function loadTrainings() {
        const resultsEl = QS('#trainingResults');
        resultsEl.innerHTML = '<div class="text-center p-4"><span class="loading-spinner"></span><p class="mt-2 text-muted">Загрузка...</p></div>';

        try {
            let data = await apiFetch('/trainings');

            const lvl = QS('#filterLevel').value;
            const type = QS('#filterType').value;
            const maxDuration = +QS('#filterDuration').value;

            if (lvl) data = data.filter(t => t.level === lvl);
            if (type) data = data.filter(t => t.type === type);
            if (maxDuration) data = data.filter(t => t.duration <= maxDuration);

            if (data.length === 0) {
                resultsEl.innerHTML = '<div class="alert alert-info">Тренировки не найдены. Попробуйте изменить фильтры.</div>';
                return;
            }

            resultsEl.innerHTML = '';
            data.forEach(t => {
                const card = document.createElement('div');
                card.className = 'training-card mb-3';
                card.innerHTML = `
                    <div class="card p-3">
                        <div class="d-flex justify-content-between align-items-start">
                            <div>
                                <strong class="d-block mb-1">${t.title}</strong>
                                <div class="small text-muted">
                                    <i class="bi bi-award me-1"></i>${t.level === 'beginner' ? 'Начинающий' : 'Продвинутый'} ·
                                    <i class="bi bi-lightning me-1"></i>${t.type === 'cardio' ? 'Кардио' : 'Силовая'} ·
                                    <i class="bi bi-clock me-1"></i>${t.duration} мин
                                </div>
                            </div>
                            <span class="badge bg-primary">${t.duration} мин</span>
                        </div>
                        <button class="btn btn-sm btn-primary mt-3 details-btn" data-title="${t.title}" data-id="${t.id}">
                            <i class="bi bi-play-circle me-1"></i>Подробнее
                        </button>
                    </div>
                `;
                resultsEl.appendChild(card);
            });

            const info = document.createElement('div');
            info.className = 'alert alert-success mb-3';
            info.innerHTML = `<i class="bi bi-check-circle me-2"></i>Найдено тренировок: ${data.length}`;
            resultsEl.prepend(info);

        } catch (error) {
            resultsEl.innerHTML = `
                <div class="alert alert-danger">
                    <i class="bi bi-exclamation-triangle me-2"></i>
                    Сервер недоступен. Убедитесь, что json-server запущен на порту 3000.
                    <div class="small mt-2">Команда: <code>npx json-server --watch db.json --port 3000</code></div>
                </div>
            `;
        }
    }

    QS('#loginForm').addEventListener('submit', async e => {
        e.preventDefault();

        const btn = e.target.querySelector('button[type="submit"]');
        const btnText = btn.querySelector('.btn-text');
        const btnSpinner = btn.querySelector('.btn-spinner');

        btn.disabled = true;
        btnText.classList.add('d-none');
        btnSpinner.classList.remove('d-none');

        try {
            const email = QS('#loginEmail').value;
            const pass = QS('#loginPassword').value;

            const users = await apiFetch('/users?email=' + encodeURIComponent(email));
            const user = users[0];

            if (!user || user.password !== pass) {
                alert('Неверный email или пароль');
                return;
            }

            setAuth('mock-token-' + Date.now(), user);
            QS('#userNameDisplay').textContent = user.name;
            updateNav();
            showPage('dashboard');
            e.target.reset();

        } catch (error) {
            alert('Сервер недоступен. Проверьте, что json-server запущен.');
        } finally {
            btn.disabled = false;
            btnText.classList.remove('d-none');
            btnSpinner.classList.add('d-none');
        }
    });

    QS('#registrationForm').addEventListener('submit', async e => {
        e.preventDefault();

        if (QS('#regPassword').value !== QS('#regPasswordConfirm').value) {
            alert('Пароли не совпадают');
            return;
        }

        try {
            const newUser = {
                email: QS('#regEmail').value,
                password: QS('#regPassword').value,
                name: QS('#regName').value
            };

            await apiFetch('/users', {
                method: 'POST',
                body: JSON.stringify(newUser)
            });

            alert('Регистрация успешна! Теперь войдите в систему.');
            showPage('login');
            e.target.reset();

        } catch (error) {
            alert('Ошибка регистрации. Сервер недоступен.');
        }
    });

    QS('#logoutBtn').addEventListener('click', () => {
        clearAuth();
        updateNav();
        showPage('home');
    });

    QS('#applyFiltersBtn').addEventListener('click', loadTrainings);

    const durationRange = QS('#filterDuration');
    const durationValue = QS('#durationValue');
    if (durationRange && durationValue) {
        durationValue.textContent = durationRange.value;
        durationRange.addEventListener('input', () => {
            durationValue.textContent = durationRange.value;
        });
    }

    QS('#trainingResults')?.addEventListener('click', e => {
        const btn = e.target.closest('.details-btn');
        if (!btn) return;
        QS('#modalTrainingTitle').textContent = btn.dataset.title;
        QS('#trainingVideo').src = 'https://www.youtube.com/embed/dQw4w9WgXcQ';
        new bootstrap.Modal('#trainingDetailModal').show();
    });

    QS('#applyBlogFilters')?.addEventListener('click', () => {
        const category = QS('#blogCategoryFilter').value;
        const searchTerm = QS('#blogSearchInput').value.toLowerCase();

        QSA('.blog-post').forEach(post => {
            const postCategory = post.dataset.category;
            const postText = post.textContent.toLowerCase();

            const categoryMatch = !category || postCategory === category;
            const searchMatch = !searchTerm || postText.includes(searchTerm);

            post.style.display = (categoryMatch && searchMatch) ? '' : 'none';
        });
    });

    QS('#blogPostsContainer')?.addEventListener('click', e => {
        const btn = e.target.closest('.blog-read-btn');
        if (!btn) return;
        e.preventDefault();

        QS('#blogPostTitle').textContent = btn.dataset.title;
        QS('#blogPostContent').textContent = btn.dataset.content;
        new bootstrap.Modal('#blogPostModal').show();
    });

    document.addEventListener('click', e => {
        const link = e.target.closest('[data-page]');
        if (!link) return;
        e.preventDefault();
        showPage(link.dataset.page);
    });

    document.addEventListener('DOMContentLoaded', () => {
        const user = getUser();
        if (user) {
            QS('#userNameDisplay').textContent = user.name;
        }
        updateNav();
        showPage('home');
    });
</script>
</body>
</html>