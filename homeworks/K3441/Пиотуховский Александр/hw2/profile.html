<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Личный профиль пользователя SharCook - ваши рецепты, посты и сохраненное">
    <title>Профиль - SharCook</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    <link rel="stylesheet" href="css/style.css">
</head>
<body>
    <a href="#main-content" class="visually-hidden-focusable">Перейти к профилю</a>

    <nav class="navbar navbar-expand-lg navbar-light bg-white shadow-sm sticky-top" role="navigation" aria-label="Основная навигация">
        <div class="container">
            <a class="navbar-brand d-flex align-items-center" href="index.html" aria-label="SharCook - Главная страница">
                <i class="bi bi-egg-fried fs-3 text-primary me-2" aria-hidden="true"></i>
                <span class="fw-bold">SharCook</span>
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Переключить навигацию">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto me-3">
                    <li class="nav-item">
                        <a class="nav-link" href="index.html">Главная</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="search.html">Поиск</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active" href="profile.html" aria-current="page">Профиль</a>
                    </li>
                </ul>
                <div class="d-flex gap-2" id="auth-buttons" role="navigation" aria-label="Действия пользователя">
                    <button class="btn btn-outline-danger" onclick="logout()" aria-label="Выйти из аккаунта">
                        <i class="bi bi-box-arrow-right me-1" aria-hidden="true"></i>
                        Выход
                    </button>
                </div>
            </div>
        </div>
    </nav>

    <main id="main-content">
        <section class="profile-section py-5" aria-labelledby="profile-heading">
        <div class="container">
            <div class="profile-header mb-5">
                <div class="row align-items-center">
                    <div class="col-md-auto text-center text-md-start mb-3 mb-md-0">
                        <img
                            src="https://placehold.co/150x150/ff6b6b/ffffff?text=АК"
                            alt="Profile Avatar"
                            class="profile-avatar"
                        >
                    </div>
                    <div class="col-md">
                        <div class="d-flex flex-column flex-md-row justify-content-between align-items-start align-items-md-center mb-3">
                            <!-- Потом будет нормальная загрузка -->
                            <div>
                                <h1 id="profile-heading" class="fw-bold mb-1 h2">Анна Кулинарова</h1>
                                <p class="text-muted mb-0">
                                    <i class="bi bi-envelope me-1" aria-hidden="true"></i>
                                    anna.kulinarova@example.com
                                </p>
                                <p class="text-muted small mb-0">
                                    <i class="bi bi-calendar me-1" aria-hidden="true"></i>
                                    На сайте с января 2024
                                </p>
                            </div>
                            <button class="btn btn-outline-primary mt-3 mt-md-0" aria-label="Редактировать профиль">
                                <i class="bi bi-pencil me-2" aria-hidden="true"></i>
                                Редактировать профиль
                            </button>
                        </div>

                        <div class="profile-stats">
                            <div class="stat-item">
                                <div class="stat-number">24</div>
                                <div class="stat-label">Рецептов</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-number">1.2K</div>
                                <div class="stat-label">Подписчиков</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-number">342</div>
                                <div class="stat-label">Подписок</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-number">89</div>
                                <div class="stat-label">Постов</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <ul class="nav nav-tabs profile-tabs mb-4" role="tablist">
                <li class="nav-item" role="presentation">
                    <button
                        class="nav-link active"
                        data-bs-toggle="tab"
                        data-bs-target="#my-recipes"
                        type="button"
                        role="tab"
                    >
                        <i class="bi bi-book me-2"></i>
                        Мои рецепты
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button
                        class="nav-link"
                        data-bs-toggle="tab"
                        data-bs-target="#saved-recipes"
                        type="button"
                        role="tab"
                    >
                        <i class="bi bi-bookmark-heart me-2"></i>
                        Сохранённые
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button
                        class="nav-link"
                        data-bs-toggle="tab"
                        data-bs-target="#my-posts"
                        type="button"
                        role="tab"
                    >
                        <i class="bi bi-newspaper me-2"></i>
                        Мои посты
                    </button>
                </li>
            </ul>

            <div class="tab-content">
                <div class="tab-pane fade show active" id="my-recipes" role="tabpanel">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <h4 class="fw-bold mb-0">Мои рецепты (0)</h4>
                        <a href="recipe.html" class="btn btn-primary">
                            <i class="bi bi-plus-circle me-2"></i>
                            Добавить рецепт
                        </a>
                    </div>

                    <div class="recipes-grid">
                    </div>
                </div>

                <div class="tab-pane fade" id="saved-recipes" role="tabpanel">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <h4 class="fw-bold mb-0">Сохранённые рецепты (0)</h4>
                    </div>

                    <div class="recipes-grid">
                    </div>
                </div>

                <div class="tab-pane fade" id="my-posts" role="tabpanel">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <h4 class="fw-bold mb-0">Мои посты (0)</h4>
                        <button class="btn btn-primary">
                            <i class="bi bi-plus-circle me-2"></i>
                            Создать пост
                        </button>
                    </div>

                    <div id="posts-feed">
                    </div>
                </div>
            </div>
        </section>
    </main>


    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="js/api.js"></script>
    <script src="js/mocks.js"></script>
    <script src="js/main.js"></script>

    <script>
        const token = localStorage.getItem('access_token');

        if (!token) {
            window.location.href = 'login.html';
        }

        async function loadProfileRecipes() {
            try {
                let recipes, users, posts, currentUser, savedRecipeIds, favoriteRecipes;
                try {
                    if (!api.isLoggedIn()) {
                        window.location.href = 'login.html';
                        return;
                    }

                    currentUser = await api.getCurrentUser();
                    if (!currentUser) {
                        window.location.href = 'login.html';
                        return;
                    }

                    recipes = await api.getRecipes(currentUser.id);
                    posts = await api.getPosts(currentUser.id);
                    users = await api.getUsers();

                    favoriteRecipes = await api.getUserFavoriteRecipes(currentUser.id);
                } catch (apiError) {
                    console.log("API unavailable, using local mocks:", apiError);
                    recipes = await MockData.loadJSON('mocks/recipes.json');
                    users = await MockData.loadJSON('mocks/users.json');
                    posts = await MockData.loadJSON('mocks/posts.json');
                    const currentUserId = 1;
                    currentUser = users.find(u => u.id === currentUserId);

                    recipes = recipes.filter(r => r.authorId === currentUserId);
                    posts = posts ? posts.filter(p => p.authorId === currentUserId) : [];
                    favoriteRecipes = recipes.filter(r => r.authorId !== currentUserId);
                }

                if (!currentUser) {
                    console.error('Failed to load user data');
                    window.location.href = 'login.html';
                    return;
                }

                const currentUserId = currentUser.id;
                const myRecipes = recipes || [];
                const savedRecipes = favoriteRecipes || [];
                const myPosts = posts || [];

                const myRecipesGrid = document.querySelector('#my-recipes .recipes-grid');
                if (myRecipesGrid) {
                    myRecipesGrid.innerHTML = myRecipes.map(recipe => {
                        return MockData.renderRecipeCard(recipe, currentUser);
                    }).join('');
                }

                const myRecipesTitle = document.querySelector('#my-recipes h4');
                if (myRecipesTitle) {
                    myRecipesTitle.textContent = `Мои рецепты (${myRecipes.length})`;
                }

                const savedRecipesGrid = document.querySelector('#saved-recipes .recipes-grid');
                if (savedRecipesGrid) {
                    savedRecipesGrid.innerHTML = savedRecipes.map(recipe => {
                        const author = users.find(u => u.id === recipe.authorId);
                        return MockData.renderRecipeCard(recipe, author);
                    }).join('');
                }

                const savedRecipesTitle = document.querySelector('#saved-recipes h4');
                if (savedRecipesTitle) {
                    savedRecipesTitle.textContent = `Сохранённые рецепты (${savedRecipes.length})`;
                }

                const postsFeed = document.getElementById('posts-feed');
                if (postsFeed && myPosts.length > 0) {
                    postsFeed.innerHTML = myPosts.map(post => {
                        return MockData.renderPostCard(post, currentUser);
                    }).join('');
                } else if (postsFeed) {
                    postsFeed.innerHTML = '<div class="alert alert-info"><i class="bi bi-info-circle me-2"></i>У вас пока нет постов</div>';
                }

                const myPostsTitle = document.querySelector('#my-posts h4');
                if (myPostsTitle) {
                    myPostsTitle.textContent = `Мои посты (${myPosts.length})`;
                }

                document.querySelector('.profile-stats .stat-item:first-child .stat-number').textContent = myRecipes.length;

                const statsItems = document.querySelectorAll('.profile-stats .stat-item');
                if (statsItems.length >= 4) {
                    statsItems[3].querySelector('.stat-number').textContent = myPosts.length;
                }

                const profileAvatar = document.querySelector('.profile-avatar');
                if (profileAvatar) {
                    profileAvatar.src = currentUser.photoUrl || `https://placehold.co/150x150/ff6b6b/ffffff?text=${currentUser.firstName?.[0] || 'U'}`;
                    profileAvatar.alt = `${currentUser.firstName || ''} ${currentUser.lastName || ''}`;
                }

                const profileName = document.querySelector('.profile-header h2');
                if (profileName) {
                    profileName.textContent = `${currentUser.firstName || ''} ${currentUser.lastName || ''}`.trim() || currentUser.username;
                }

                const profileEmail = document.querySelector('.profile-header .text-muted');
                if (profileEmail) {
                    profileEmail.innerHTML = `<i class="bi bi-envelope me-1"></i>${currentUser.email}`;
                }

            } catch (error) {
                console.error('Error loading profile recipes:', error);
            }
        }

        function logout() {
            if (confirm('Вы уверены, что хотите выйти?')) {
                api.logout();
                showToast('Вы вышли из аккаунта', 'info');
                setTimeout(() => {
                    window.location.href = 'index.html';
                }, 1500);
            }
        }

        loadProfileRecipes();
        updateAuthUI();
    </script>
</body>
</html>
