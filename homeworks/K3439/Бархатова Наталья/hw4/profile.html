<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Личный кабинет</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="/css/base.css">
    <link id="theme-style" rel="stylesheet" href="/css/theme-light.css">
    <script src="/js/theme.js" defer></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
</head>
<body>

<header>
    <nav class="navbar navbar-dark" aria-label="Навигация по сайту">
        <div class="container d-flex align-items-center">
            <a href="main.html" class="navbar-brand">
                <svg class="icon" width="24" height="24">
                    <use href="svg-sprites/sprites.svg#arrow"></use>
                </svg>
                <span>Назад к списку ресторанов</span>
            </a>
        </div>
    </nav>
</header>

<main class="profile-container">

    <section class="d-flex align-items-center mb-4" aria-labelledby="profile-info-title">
        <img id="profileAvatar" src="images/icon.png" alt="Аватар пользователя" class="profile-avatar me-4">
        <div>
            <div id="profileName" class="profile-name">Иван</div>
            <div id="profileEmail" class="text-muted mt-1">ivan@example.com</div>
        </div>
    </section>

    <section class="info-card" aria-labelledby="upcoming-title">
        <h2 id="upcoming-title" class="info-title">Актуальные бронирования</h2>
        <ul id="upcomingBookings" class="list-unstyled mb-0" role="list"></ul>
    </section>

    <section class="info-card" aria-labelledby="past-title">
        <h2 id="past-title" class="info-title">История бронирований</h2>
        <ul id="pastBookings" class="list-unstyled mb-0" role="list"></ul>
    </section>

    <div class="mt-3 d-flex gap-2 align-items-center">
        <a href="edit_profile.html" class="btn btn-primary d-flex align-items-center">
            <svg class="icon me-1" width="20" height="20">
                <use href="svg-sprites/sprites.svg#edit"></use>
            </svg>
            Изменить данные
        </a>

        <a href="password_recovery.html" class="btn btn-primary d-flex align-items-center">
            <svg class="icon me-1" width="20" height="20">
                <use href="svg-sprites/sprites.svg#lock"></use>
            </svg>
            Сменить пароль
        </a>

        <button class="btn btn-primary d-flex align-items-center" onclick="toggleTheme()">
            <svg class="icon me-1" width="20" height="20">
                <use href="svg-sprites/sprites.svg#moon"></use>
            </svg>
            Переключить тему
        </button>
    </div>

</main>

<footer class="text-center mt-4 mb-4">
    <p>© 2025 Вечер под контролем</p>
</footer>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script>
    if (!localStorage.getItem("token")) {
        window.location.href = "login.html";
    }

    async function loadProfile() {
        const userId = localStorage.getItem("userId");

        if (!userId) {
            window.location.href = "login.html";
            return;
        }

        try {
            const userRes = await fetch(`http://localhost:3000/users/${userId}`);
            const user = await userRes.json();
            document.getElementById("profileName").textContent = user.name;
            document.getElementById("profileEmail").textContent = user.email;
            if (user.avatar) {
                document.getElementById("profileAvatar").src = user.avatar;
            }

            const bookingsRes = await fetch(`http://localhost:3000/bookings?userId=${userId}`);
            const bookings = await bookingsRes.json();

            const restaurantsRes = await fetch(`http://localhost:3000/restaurants`);
            const restaurants = await restaurantsRes.json();
            const restaurantsMap = {};
            restaurants.forEach(r => restaurantsMap[r.id] = r.name);

            const now = new Date();
            const upcomingList = document.getElementById("upcomingBookings");
            const pastList = document.getElementById("pastBookings");

            bookings.forEach(b => {
                const bookingDate = new Date(`${b.date}T${b.time}`);
                const restaurantName = restaurantsMap[b.restaurantId] || "Неизвестный ресторан";
                const li = document.createElement("li");
                li.textContent = `${restaurantName} — ${b.date} / ${b.time}`;

                if (bookingDate >= now) {
                    upcomingList.appendChild(li);
                } else {
                    pastList.appendChild(li);
                }
            });

        } catch (error) {
            console.error(error);
            alert("Не удалось загрузить данные профиля");
        }
    }
    loadProfile();
</script>
</body>
</html>