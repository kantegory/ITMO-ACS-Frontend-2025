<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Личный кабинет</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
</head>
<body>

<header>
    <nav class="navbar navbar-dark">
        <div class="container d-flex align-items-center">
            <a href="main.html" class="navbar-brand">
                <i class="bi bi-arrow-left-circle"></i> Назад к списку ресторанов
            </a>
        </div>
    </nav>
</header>

<main class="profile-container">

    <section class="d-flex align-items-center mb-4">
        <img id="profileAvatar" src="images/icon.png" alt="avatar" class="profile-avatar me-4">
        <div>
            <div id="profileName" class="profile-name">Иван</div>
            <div id="profileEmail" class="text-muted mt-1">ivan@example.com</div>
        </div>
    </section>

    <section class="info-card">
        <div class="info-title">Актуальные бронирования</div>
        <ul id="upcomingBookings" class="list-unstyled mb-0"></ul>
    </section>

    <section class="info-card">
        <div class="info-title">История бронирований</div>
        <ul id="pastBookings" class="list-unstyled mb-0"></ul>
    </section>

    <a href="edit_profile.html" class="btn btn-primary me-2">Изменить данные</a>
    <button class="btn btn-primary me-2">Сменить пароль</button>

</main>

<footer class="text-center mt-4 mb-4">
    <p>© 2025 Вечер под контролем</p>
</footer>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script>
    if (!localStorage.getItem("token")) {
        window.location.href = "login.html";
    }

    async function loadProfile() {
        const userId = localStorage.getItem("userId");

        if (!userId) {
            window.location.href = "login.html";
            return;
        }

        try {
            const userRes = await fetch(`http://localhost:3000/users/${userId}`);
            const user = await userRes.json();
            document.getElementById("profileName").textContent = user.name;
            document.getElementById("profileEmail").textContent = user.email;
            if (user.avatar) {
                document.getElementById("profileAvatar").src = user.avatar;
            }

            const bookingsRes = await fetch(`http://localhost:3000/bookings?userId=${userId}`);
            const bookings = await bookingsRes.json();

            const restaurantsRes = await fetch(`http://localhost:3000/restaurants`);
            const restaurants = await restaurantsRes.json();
            const restaurantsMap = {};
            restaurants.forEach(r => restaurantsMap[r.id] = r.name);

            const now = new Date();
            const upcomingList = document.getElementById("upcomingBookings");
            const pastList = document.getElementById("pastBookings");

            bookings.forEach(b => {
                const bookingDate = new Date(`${b.date}T${b.time}`);
                const restaurantName = restaurantsMap[b.restaurantId] || "Неизвестный ресторан";
                const li = document.createElement("li");
                li.textContent = `${restaurantName} — ${b.date} / ${b.time}`;

                if (bookingDate >= now) {
                    upcomingList.appendChild(li);
                } else {
                    pastList.appendChild(li);
                }
            });

        } catch (error) {
            console.error(error);
            alert("Не удалось загрузить данные профиля");
        }
    }
    loadProfile();
</script>
</body>
</html>